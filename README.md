# 即時雙向翻譯系統

一個即時雙向翻譯系統，支援語音識別、自動語言偵測、即時翻譯功能。系統採用透明螢幕設計，讓雙方使用者都能看到各自語言的翻譯內容。

## 系統特色

**核心功能**：
- **連續語音識別**：使用 OpenAI Whisper API 進行高精度語音轉文字
- **自動語言偵測**：智能判斷說話者角色（台灣人或外國人）
- **即時翻譯**：使用 OpenAI GPT 進行醫療場景專業翻譯
- **文字轉語音**：自動播放翻譯結果的語音
- **透明螢幕雙字幕**：正反面都能清晰看到各自語言的字幕

**支援語言**：
- 台灣人：中文（繁體/簡體）
- 外國人：越南語、印尼語、菲律賓語（他加祿語）、英文、義大利語等

## 技術架構

**前端**：
- React 19 + TypeScript
- Tailwind CSS 4
- tRPC 11（型別安全的 API 呼叫）
- MediaRecorder API（連續錄音）

**後端**：
- Node.js + Express 4
- tRPC 11（型別安全的 API 路由）
- MySQL/TiDB（資料庫）
- OpenAI API（Whisper、GPT、TTS）

## 📋 PORT 配置

**⚠️ 重要：所有 port 配置集中管理於 [`PORTS.md`](./PORTS.md)**

### 當前使用的 Port

| Port | 服務 | 狀態 |
|------|------|------|
| 3000 | Node.js App | ✅ 運行中 |
| 8080 | Hybrid ASR | ⚠️ 保留 |
| 8081 | Go REST API | ❌ 停用 |

### Port 衝突檢查

```bash
# 檢查所有已分配的 port
lsof -i :3000 -i :8080 -i :8081

# 檢查單個 port
lsof -i :3000
```

**詳細說明請參閱 [`PORTS.md`](./PORTS.md)**

---

## 快速開始

### 環境需求

- Node.js 22+
- pnpm 10+
- MySQL 或 TiDB 資料庫

### 安裝步驟

1. **安裝相依套件**：
   ```bash
   pnpm install
   ```

2. **設定環境變數**：
   系統已預先配置 OpenAI API Key，無需額外設定。

3. **推送資料庫 Schema**：
   ```bash
   pnpm db:push
   ```

4. **啟動開發伺服器**：
   ```bash
   pnpm dev
   ```

5. **開啟瀏覽器**：
   訪問 `http://localhost:3000` 即可使用系統。

## 使用方式

### 基本操作流程

1. **開啟系統**：在瀏覽器中開啟網站
2. **授權麥克風**：首次使用時需授權瀏覽器存取麥克風
3. **開始錄音**：點擊「開始錄音」按鈕
4. **自由對話**：
   - 護理師說中文，系統自動翻譯成病患語言
   - 病患說外語，系統自動翻譯成中文
5. **查看字幕**：
   - **大字（Primary）**：給接收翻譯的一方看
   - **小字（Secondary）**：給說話的一方看（原文確認）
6. **聆聽語音**：系統自動播放翻譯後的語音

### Demo 測試對話

**場景一：台灣人詢問外國人**
- 台灣人（中文）：「你好嗎？」
- 系統顯示：
  - Primary（大字）：「Bạn có đau không?」（越南語）
  - Secondary（小字）：「你好嗎？」
- 系統播放：越南語語音

**場景二：外國人回應**
- 外國人（越南語）：「Tôi khỏe, cảm ơn.」
- 系統顯示：
  - Primary（大字）：「我很好，謝謝。」（中文）
  - Secondary（小字）："Tôi khỏe, cảm ơn."
- 系統播放：中文語音

## 系統架構說明

### 自動翻譯流程

系統採用完全自動化的翻譯流程，無需手動選擇語言或角色：

1. **語音錄製**：每 2 秒自動切片並上傳
2. **語音識別**：Whisper API 轉換為文字並偵測語言
4. **角色判斷**：
   - 若偵測到中文 → 判定為台灣人 → 翻譯成外國人語言
   - 若偵測到外語 → 判定為外國人 → 翻譯成中文
4. **翻譯處理**：GPT API 進行醫療場景專業翻譯
5. **語音合成**：TTS API 生成目標語言語音
6. **字幕更新**：根據翻譯方向自動調整主次字幕
7. **語音播放**：自動播放翻譯後的語音

### API 端點

**tRPC 路由**：
- `translation.autoTranslate`：整合端點（ASR + 翻譯 + TTS）
- `translation.getRecent`：取得最近的翻譯記錄

### 資料庫結構

**translations 表**：
- `id`：主鍵
- `direction`：翻譯方向（nurse_to_patient / patient_to_nurse）
- `sourceLang`：來源語言代碼
- `targetLang`：目標語言代碼
- `sourceText`：原始文字
- `translatedText`：翻譯文字
- `audioUrl`：TTS 音訊 URL
- `createdAt`：建立時間

**languageConfig 表**：
- `id`：主鍵
- `code`：語言代碼
- `name`：語言名稱
- `role`：角色（nurse / patient）
- `isActive`：是否啟用

## 透明螢幕設計

系統採用透明螢幕設計理念，適合輸出到實體透明顯示器：

**視覺設計**：
- 背景：黑色，透明度 30%
- Primary 字體：白色，55px，粗體
- Secondary 字體：白色/70% 透明度，32px
- 方向指示器：白色/60% 透明度，18px

**顯示邏輯**：
- 台灣人說話時：外國人看到大字外語翻譯，台灣人看到小字中文原文
- 外國人說話時：台灣人看到大字中文翻譯，外國人看到小字外語原文

## 測試

執行單元測試：

```bash
# 測試 OpenAI API 連線
pnpm test server/openai.test.ts

# 測試翻譯服務
pnpm test server/translation.test.ts

# 執行所有測試
pnpm test
```

## 開發指令

```bash
# 開發模式（熱重載）
pnpm dev

# 建置生產版本
pnpm build

# 啟動生產伺服器
pnpm start

# 推送資料庫 Schema
pnpm db:push

# 執行測試
pnpm test
```

## 注意事項

1. **麥克風權限**：首次使用需授權瀏覽器存取麥克風
2. **網路連線**：需要穩定的網路連線以呼叫 OpenAI API
3. **音訊格式**：系統使用 WebM 格式錄音，大部分現代瀏覽器都支援
4. **API 額度**：OpenAI API 為付費服務，請確保帳戶有足夠額度
5. **語音品質**：建議在安靜環境中使用以提高識別準確度

## 未來擴展

- 支援更多語言（泰語、緬甸語等）
- 離線模式（本地語音識別）
- 翻譯記錄匯出功能
- 多人對話場景支援
- 醫療專業術語庫

## 授權

本專案為 PoC（概念驗證）系統，僅供內部測試使用。

## 技術支援

如有問題或建議，請聯繫開發團隊。
