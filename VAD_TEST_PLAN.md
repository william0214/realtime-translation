# VAD ç³»çµ±æ¸¬è©¦è¨ˆç•«

**æ¸¬è©¦æ—¥æœŸï¼š** 2025-12-25  
**æ¸¬è©¦ç‰ˆæœ¬ï¼š** v1.4.0  
**æ¸¬è©¦ç›®çš„ï¼š** é©—è­‰ VAD/ASR ä¿®å¾©æ˜¯å¦æ­£å¸¸é‹ä½œ

---

## ğŸ“‹ æ¸¬è©¦ç¯„åœ

### 1. é›™é–€æª» VAD æ¸¬è©¦
- Start threshold: 0.060ï¼ˆé€£çºŒ >= 3 å¹€ï¼‰
- End threshold: 0.045ï¼ˆé€£çºŒ >= 8 å¹€ï¼‰
- é©—è­‰æ˜¯å¦æ¸›å°‘ RMS æŠ–å‹•

### 2. Segment æ©Ÿåˆ¶æ¸¬è©¦
- é©—è­‰ segment ç”Ÿå‘½é€±æœŸç®¡ç†
- é©—è­‰ async response çš„ segment æª¢æŸ¥
- é©—è­‰ segment å–æ¶ˆå’Œ abort æ©Ÿåˆ¶

### 3. éŸ³è¨Šè·¯å¾‘åˆ†é›¢æ¸¬è©¦
- Partial bufferï¼šæ»‘å‹•çª—å£ï¼ˆ1.5sï¼‰
- Final bufferï¼šç´¯ç©éŸ³è¨Š + hard-trimï¼ˆâ‰¤ 2.0sï¼‰
- é©—è­‰å…©è€…ç¨ç«‹é‹ä½œ

### 4. ASR è¼¸å‡ºæ¸…æ´—æ¸¬è©¦
- é©—è­‰åƒåœ¾è¼¸å‡ºéæ¿¾
- é©—è­‰æ­£å¸¸æ–‡å­—ä¸è¢«èª¤éæ¿¾

### 5. stopRecording æ¸…ç†æ¸¬è©¦
- é©—è­‰æ‰€æœ‰ segment æ­£ç¢ºæ¸…ç†
- é©—è­‰ buffer å’Œ refs æ­£ç¢ºé‡ç½®

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šæ­£å¸¸å°è©±ï¼ˆé€£çºŒ 10 å¥ï¼‰
**ç›®çš„ï¼š** é©—è­‰ partial å’Œ final ç©©å®šé‹ä½œ

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. é€£çºŒè¬› 10 å¥ä¸­æ–‡ï¼ˆæ¯å¥ 2-3 ç§’ï¼‰
3. æ¯å¥ä¹‹é–“åœé “ 1-2 ç§’
4. è§€å¯Ÿ Console æ—¥èªŒå’Œ UI é¡¯ç¤º

**é æœŸçµæœï¼š**
- âœ… æ¯å¥éƒ½æœ‰ partial å­—å¹•æ›´æ–°ï¼ˆé»ƒæ¡†ï¼‰
- âœ… æ¯å¥éƒ½æœ‰ final ç¿»è­¯ï¼ˆè—æ¡†ï¼‰
- âœ… Console æ²’æœ‰ "No partial message to update" éŒ¯èª¤
- âœ… Segment ID æ­£å¸¸éå¢ï¼ˆ#1, #2, #3...ï¼‰
- âœ… Final chunk duration åœ¨ 0.8-2.0s ä¹‹é–“

**æ¸¬è©¦å¥å­ç¯„ä¾‹ï¼š**
```
1. ä½ å¥½ï¼Œæˆ‘æ˜¯è­·ç†å¸«
2. è«‹å•ä½ å“ªè£¡ä¸èˆ’æœ
3. æˆ‘éœ€è¦å¹«ä½ é‡é«”æº«
4. è«‹å¼µé–‹å˜´å·´
5. ç¾åœ¨è¦å¹«ä½ æ‰“é‡
6. è«‹æ”¾è¼•é¬†ä¸è¦ç·Šå¼µ
7. ç­‰ä¸€ä¸‹æœƒæœ‰é»ç—›
8. å·²ç¶“æ‰“å®Œäº†
9. è«‹åœ¨é€™è£¡ä¼‘æ¯ä¸€ä¸‹
10. æœ‰å•é¡Œéš¨æ™‚å«æˆ‘
```

---

### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šå¿«é€ŸçŸ­éŸ³ï¼ˆ< 800msï¼‰
**ç›®çš„ï¼š** é©—è­‰çŸ­éŸ³è¢«æ­£ç¢ºä¸Ÿæ£„ä¸”ä¸ç”¢ç”ŸéŒ¯èª¤

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. å¿«é€Ÿè¬› 5 å€‹çŸ­éŸ³ï¼ˆå’³å—½ã€æ¸…å–‰åš¨ã€ã€Œå—¯ã€ã€ã€Œå•Šã€ç­‰ï¼‰
3. æ¯å€‹çŸ­éŸ³ < 0.8 ç§’
4. è§€å¯Ÿ Console æ—¥èªŒå’Œ UI é¡¯ç¤º

**é æœŸçµæœï¼š**
- âœ… Console é¡¯ç¤º "Speech too short (XXXms < 800ms), discarding as noise"
- âœ… Console é¡¯ç¤º "Cancel segment to prevent async responses from updating UI"
- âœ… UI ä¸é¡¯ç¤ºé€™äº›çŸ­éŸ³çš„å­—å¹•
- âœ… æ²’æœ‰ "No partial message to update" éŒ¯èª¤
- âœ… Partial message è¢«æ­£ç¢ºç§»é™¤

---

### æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šé•·å¥å­ï¼ˆ> 4 ç§’ï¼‰
**ç›®çš„ï¼š** é©—è­‰ auto-cut å’Œ hard-trim æ©Ÿåˆ¶

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. è¬›ä¸€å¥å¾ˆé•·çš„è©±ï¼ˆ> 4 ç§’ï¼‰
3. ä¸è¦åœé “ï¼Œé€£çºŒè¬›å®Œ
4. è§€å¯Ÿ Console æ—¥èªŒå’Œ UI é¡¯ç¤º

**é æœŸçµæœï¼š**
- âœ… Console é¡¯ç¤º "Speech duration exceeded 4000ms, auto-cutting segment"
- âœ… èªéŸ³è¢«è‡ªå‹•åˆ‡æ®µ
- âœ… æ¯æ®µ final chunk duration â‰¤ 2.0s
- âœ… Console é¡¯ç¤º "Hard-trimmed from X.XXs to 2.00s" æˆ– "Final chunk duration OK"
- âœ… æ²’æœ‰ "Final buffer still too long" è­¦å‘Š

**æ¸¬è©¦å¥å­ç¯„ä¾‹ï¼š**
```
ã€Œè«‹å•ä½ ä»Šå¤©æ—©ä¸Šæœ‰æ²’æœ‰åƒæ—©é¤å¦‚æœæ²’æœ‰åƒæ—©é¤çš„è©±å¯èƒ½æœƒå½±éŸ¿æª¢æŸ¥çµæœæ‰€ä»¥æˆ‘å»ºè­°ä½ å…ˆå»åƒé»æ±è¥¿å†å›ä¾†æª¢æŸ¥æ¯”è¼ƒå¥½ã€
ï¼ˆé€£çºŒè¬›å®Œï¼Œä¸åœé “ï¼‰
```

---

### æ¸¬è©¦æ¡ˆä¾‹ 4ï¼šVAD é–€æª»æ¸¬è©¦
**ç›®çš„ï¼š** é©—è­‰é›™é–€æª» VAD æ¸›å°‘æŠ–å‹•

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. ç”¨æ­£å¸¸éŸ³é‡è¬›è©±ï¼ˆRMS æ‡‰ > 0.060ï¼‰
3. ç”¨å¾ˆå°çš„éŸ³é‡è¬›è©±ï¼ˆRMS æ‡‰åœ¨ 0.045-0.060 ä¹‹é–“ï¼‰
4. è§€å¯Ÿ Console æ—¥èªŒ

**é æœŸçµæœï¼š**
- âœ… æ­£å¸¸éŸ³é‡ï¼šConsole é¡¯ç¤º "Speech START detected: RMS=0.0XXX > startThreshold=0.0600"
- âœ… å°éŸ³é‡ï¼šä¸è§¸ç™¼ speech startï¼ˆRMS < 0.060ï¼‰
- âœ… åœæ­¢èªªè©±ï¼šConsole é¡¯ç¤º "Speech END detected: RMS=0.0XXX < endThreshold=0.0450"
- âœ… æ¸›å°‘çŸ­æ®µç”¢ç”Ÿï¼ˆ< 800msï¼‰

---

### æ¸¬è©¦æ¡ˆä¾‹ 5ï¼šASR è¼¸å‡ºæ¸…æ´—æ¸¬è©¦
**ç›®çš„ï¼š** é©—è­‰åƒåœ¾è¼¸å‡ºè¢«éæ¿¾

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. è¬›ä¸€äº›å®¹æ˜“è§¸ç™¼ Whisper å¹»è¦ºçš„çŸ­éŸ³
3. è§€å¯Ÿ UI æ˜¯å¦é¡¯ç¤ºåƒåœ¾è¼¸å‡º

**é æœŸçµæœï¼š**
- âœ… ä¸é¡¯ç¤º "Speaker likely speaks Chinese, Vietnamese..."
- âœ… ä¸é¡¯ç¤º "The speaker is..."
- âœ… ä¸é¡¯ç¤º "This audio..."
- âœ… Console é¡¯ç¤º "Whisper hallucination detected, skipping"

---

### æ¸¬è©¦æ¡ˆä¾‹ 6ï¼šstopRecording æ¸…ç†æ¸¬è©¦
**ç›®çš„ï¼š** é©—è­‰åœæ­¢éŒ„éŸ³æ™‚çš„æ¸…ç†é‚è¼¯

**æ­¥é©Ÿï¼š**
1. é»æ“Šã€Œé–‹å§‹å°è©±ã€
2. è¬› 2-3 å¥è©±ï¼ˆåŒ…å«ä¸€äº› partial å­—å¹•ï¼‰
3. åœ¨ partial å­—å¹•é¡¯ç¤ºæ™‚ç«‹å³é»æ“Šã€ŒçµæŸå°è©±ã€
4. è§€å¯Ÿ Console æ—¥èªŒå’Œ UI é¡¯ç¤º

**é æœŸçµæœï¼š**
- âœ… Console é¡¯ç¤º "Stopping recording and cleaning up all segments"
- âœ… Console é¡¯ç¤º "Cleaned up X active segments"
- âœ… Console é¡¯ç¤º "Aborted X pending requests"
- âœ… UI ä¸Šçš„ partial å­—å¹•ï¼ˆé»ƒæ¡†ï¼‰æ¶ˆå¤±
- âœ… æ²’æœ‰æ®˜ç•™çš„ pending è«‹æ±‚

---

## ğŸ“Š æ—¥èªŒæª¢æŸ¥æ¸…å–®

### å¿…é ˆå‡ºç¾çš„æ—¥èªŒï¼ˆæ­£å¸¸æƒ…æ³ï¼‰
- [ ] `ğŸ†• [Segment#X] Created new segment`
- [ ] `ğŸ”µ [Segment#X] Speech started (both buffers force-cleared)`
- [ ] `[VAD] ğŸ”Š Speech START detected: RMS=X.XXXX > startThreshold=0.0600`
- [ ] `[Partial/Segment#X] Using sliding window: XX buffers (~1.5s) from partialBuffer`
- [ ] `[Partial/Segment#X] Updated partial message #X: "..."`
- [ ] `ğŸŸ¢ Speech ended (duration: XXXXms, silence: XXXms, final chunk: X.XXs)`
- [ ] `[VAD] ğŸ”‡ Speech END detected: RMS=X.XXXX < endThreshold=0.0450`
- [ ] `âœ‚ï¸ [Final] Hard-trimmed from X.XXs to 2.00s` æˆ– `[Final] Final chunk duration OK: X.XXs`

### å¿…é ˆå‡ºç¾çš„æ—¥èªŒï¼ˆçŸ­éŸ³è¢«ä¸Ÿæ£„ï¼‰
- [ ] `âš ï¸ [Segment#X] Speech too short (XXXms < 800ms), discarding as noise`
- [ ] `ğŸš« Cancel segment to prevent async responses from updating UI`
- [ ] `[ASR/Segment#X] Removed partial message #X (speech too short)`

### å¿…é ˆå‡ºç¾çš„æ—¥èªŒï¼ˆé•·å¥ auto-cutï¼‰
- [ ] `âš ï¸ Speech duration exceeded 4000ms, auto-cutting segment`
- [ ] `âœ‚ï¸ [Final] Hard-trimmed from X.XXs to 2.00s`

### å¿…é ˆå‡ºç¾çš„æ—¥èªŒï¼ˆstopRecordingï¼‰
- [ ] `Stopping recording and cleaning up all segments`
- [ ] `Cleaned up X active segments`
- [ ] `Aborted X pending requests`

### ä¸æ‡‰è©²å‡ºç¾çš„éŒ¯èª¤æ—¥èªŒ
- [ ] âŒ `No partial message to update`ï¼ˆæ‡‰è¿‘ä¹æ¶ˆå¤±ï¼‰
- [ ] âŒ `Final buffer still too long ... this should not happen`
- [ ] âŒ `Segment#X not active, ignoring response`ï¼ˆé™¤é segment è¢«å–æ¶ˆï¼‰

---

## ğŸ¯ é©—æ”¶æ¨™æº–

### å¿…é ˆé€šéçš„æŒ‡æ¨™
1. **Segment å–æ¶ˆç‡**ï¼š< 10%ï¼ˆçŸ­éŸ³è¢«ä¸Ÿæ£„æ˜¯æ­£å¸¸çš„ï¼‰
2. **Partial æ›´æ–°é »ç‡**ï¼š~3-4 æ¬¡/ç§’ï¼ˆæ¯ 300ms ä¸€æ¬¡ï¼‰
3. **Final chunk å¹³å‡é•·åº¦**ï¼š~1.5sï¼ˆç¯„åœ 0.8-2.0sï¼‰
4. **ASR åƒåœ¾è¼¸å‡ºç‡**ï¼š< 1%
5. **Console éŒ¯èª¤ç‡**ï¼š"No partial message to update" < 1%

### æ¸¬è©¦é€šéæ¢ä»¶
- âœ… æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹çš„é æœŸçµæœéƒ½é”æˆ
- âœ… æ‰€æœ‰å¿…é ˆå‡ºç¾çš„æ—¥èªŒéƒ½å‡ºç¾
- âœ… æ‰€æœ‰ä¸æ‡‰è©²å‡ºç¾çš„éŒ¯èª¤æ—¥èªŒéƒ½æ²’æœ‰å‡ºç¾
- âœ… UI é¡¯ç¤ºç©©å®šï¼Œå­—å¹•æµæš¢
- âœ… ç¿»è­¯çµæœæ­£ç¢º

---

## ğŸ“ æ¸¬è©¦è¨˜éŒ„è¡¨

### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šæ­£å¸¸å°è©±
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šå¿«é€ŸçŸ­éŸ³
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

### æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šé•·å¥å­
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

### æ¸¬è©¦æ¡ˆä¾‹ 4ï¼šVAD é–€æª»
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

### æ¸¬è©¦æ¡ˆä¾‹ 5ï¼šASR è¼¸å‡ºæ¸…æ´—
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

### æ¸¬è©¦æ¡ˆä¾‹ 6ï¼šstopRecording æ¸…ç†
- [ ] æ¸¬è©¦å®Œæˆ
- [ ] é æœŸçµæœé”æˆ
- [ ] æ—¥èªŒæ­£ç¢º
- å‚™è¨»ï¼š_______________________

---

## ğŸ”§ æ¸¬è©¦æº–å‚™

### é–‹å•Ÿ Console æ—¥èªŒ
1. æ‰“é–‹ç€è¦½å™¨ï¼ˆChrome/Edgeï¼‰
2. æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·
3. åˆ‡æ›åˆ° Console æ¨™ç±¤
4. æ¸…ç©º Consoleï¼ˆé»æ“Š ğŸš« åœ–ç¤ºï¼‰
5. é–‹å§‹æ¸¬è©¦

### æ¸¬è©¦ç’°å¢ƒ
- **ç€è¦½å™¨**ï¼šChrome/Edgeï¼ˆå»ºè­°ä½¿ç”¨ Chromeï¼‰
- **éº¥å…‹é¢¨**ï¼šç¢ºä¿éº¥å…‹é¢¨æ¬Šé™å·²æˆäºˆ
- **ç’°å¢ƒ**ï¼šå®‰éœçš„å®¤å…§ç’°å¢ƒï¼ˆæ¸›å°‘èƒŒæ™¯å™ªéŸ³å¹²æ“¾ï¼‰
- **ç¶²è·¯**ï¼šç©©å®šçš„ç¶²è·¯é€£ç·š

---

## ğŸ“ å•é¡Œå›å ±

å¦‚æœæ¸¬è©¦ä¸­ç™¼ç¾å•é¡Œï¼Œè«‹è¨˜éŒ„ï¼š
1. **æ¸¬è©¦æ¡ˆä¾‹ç·¨è™Ÿ**
2. **å¯¦éš›çµæœ**ï¼ˆèˆ‡é æœŸçµæœçš„å·®ç•°ï¼‰
3. **Console æ—¥èªŒ**ï¼ˆå®Œæ•´çš„éŒ¯èª¤è¨Šæ¯ï¼‰
4. **æˆªåœ–**ï¼ˆå¦‚æœæœ‰ UI ç•°å¸¸ï¼‰

---

**æ¸¬è©¦é–‹å§‹æ™‚é–“ï¼š** __________  
**æ¸¬è©¦çµæŸæ™‚é–“ï¼š** __________  
**æ¸¬è©¦çµæœï¼š** â¬œ é€šé / â¬œ å¤±æ•—  
**æ¸¬è©¦äººå“¡ï¼š** __________
