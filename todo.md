# 專案待辦事項

**專案：** 即時雙向翻譯系統（護理推車）  
**當前版本：** v1.1.0  
**最後更新：** 2025-12-15

---

## 🔥 緊急修復（立即處理）

- [ ] 手動測試即時字幕清除功能（v1.1.0 bug 修復驗證）
- [ ] 修復對話摘要功能（3 個測試失敗）
- [ ] 修復翻譯數量統計錯誤（1 個測試失敗）

---

## ✅ 已完成

### v1.1.0 (2025-12-15)
- [x] 修復即時字幕在結束對話時不消失的問題
- [x] 修改 stopRecording 函數加入清除 partial 訊息邏輯
- [x] 修改 stopHybridRecording 函數加入清除邏輯
- [x] 執行完整單元測試（89.1% 通過率）
- [x] 建立測試報告（TEST_REPORT.md）
- [x] 建立版本歷史（VERSION_HISTORY.md）
- [x] 建立測試程序（TESTING_PROCEDURE.md）
- [x] 建立開發時程（DEVELOPMENT_SCHEDULE.md）

### v1.0.0 (2025-12-14)
- [x] 即時雙向翻譯功能
- [x] 支援 8 種外語翻譯
- [x] 語音識別（Whisper ASR）
- [x] 語音合成（TTS）
- [x] 語音活動檢測（VAD）
- [x] 對話記錄管理
- [x] 歷史記錄查詢
- [x] 效能監控系統
- [x] 多後端支援（Node.js, Go, Hybrid）

---

## 📋 v1.1.1 - 修復版本（預計 2025-12-16）

### 高優先級
- [ ] 修復對話摘要功能
  - [ ] 檢查 server/routers.ts:444 的 undefined 錯誤
  - [ ] 修復 LLM 回應格式處理
  - [ ] 加入錯誤處理和 fallback 機制
  - [ ] 更新相關測試

### 中優先級
- [ ] 修復翻譯數量統計錯誤
  - [ ] 檢查翻譯數量計算邏輯
  - [ ] 確保測試資料隔離
  - [ ] 更新測試案例

### 低優先級
- [ ] 優化 TTS Profiler 時間閾值
  - [ ] 調整時間閾值（80ms → 79ms）
  - [ ] 或改用範圍判斷（75-85ms）

### 測試與發布
- [ ] 執行完整單元測試
- [ ] 確保通過率 > 95%
- [ ] 更新測試報告
- [ ] 建立 checkpoint
- [ ] 部署到生產環境

---

## 🚀 v1.2.0 - 效能優化（預計 2025-12-20）

### 效能優化
- [ ] 使用 Whisper Streaming API
  - [ ] 研究 Whisper Streaming API 文件
  - [ ] 實作串流音訊處理
  - [ ] 整合到現有系統
  - [ ] 測試延遲改善（目標：降低 50%）

- [ ] 優化翻譯模型
  - [ ] 測試不同模型（gpt-3.5-turbo-instruct, gpt-4o-mini）
  - [ ] 比較延遲和品質
  - [ ] 選擇最佳模型

- [ ] 實作音訊預處理
  - [ ] 降噪處理
  - [ ] 音訊壓縮
  - [ ] 靜音移除

### 功能擴充
- [ ] 支援更多語言
  - [ ] 西班牙語（es）
  - [ ] 法語（fr）
  - [ ] 德語（de）
  - [ ] 俄語（ru）

- [ ] 建立效能監控儀表板
  - [ ] 設計儀表板 UI
  - [ ] 實作即時效能監控
  - [ ] 顯示延遲圖表
  - [ ] 顯示瓶頸分析

### 測試
- [ ] 建立前端 E2E 測試
  - [ ] 安裝 Playwright 或 Cypress
  - [ ] 撰寫基本翻譯流程測試
  - [ ] 撰寫 UI 互動測試

---

## 🎨 v1.3.0 - 進階功能（預計 2025-12-25）

### 多人對話支援
- [ ] 設計多人對話架構
- [ ] 支援 3+ 人同時對話
- [ ] 自動識別說話者
- [ ] 分別顯示每個人的對話

### 語音情緒分析
- [ ] 整合情緒分析 API
- [ ] 分析語音情緒（開心、悲傷、生氣、中性）
- [ ] 在 UI 顯示情緒標籤
- [ ] 記錄情緒到資料庫

### 對話摘要自動生成
- [ ] 修復對話摘要功能
- [ ] 實作自動摘要生成
- [ ] 對話結束後自動生成摘要
- [ ] 提取關鍵要點
- [ ] 顯示在歷史記錄中

### 對話記錄搜尋
- [ ] 實作全文搜尋
- [ ] 搜尋原文和譯文
- [ ] 支援日期範圍篩選
- [ ] 支援語言篩選
- [ ] 支援關鍵字高亮

---

## 🏗️ v2.0.0 - 重大架構升級（預計 2026-01-01）

### 前端重構
- [ ] 遷移到 Next.js
- [ ] 設定 Next.js 專案
- [ ] 遷移現有元件
- [ ] 實作 SSR/SSG
- [ ] 優化 SEO

### 後端重構
- [ ] 遷移到 NestJS
- [ ] 設定 NestJS 專案
- [ ] 遷移現有 API
- [ ] 實作微服務架構
- [ ] 優化效能

### 離線模式支援
- [ ] 實作 Service Worker
- [ ] 實作離線資料同步
- [ ] 實作本地儲存
- [ ] 實作衝突解決

### 自定義翻譯模型
- [ ] 支援自訂翻譯模型
- [ ] 支援模型微調
- [ ] 支援本地模型部署

### WebRTC 點對點通訊
- [ ] 實作 WebRTC 連線
- [ ] 實作點對點音訊傳輸
- [ ] 實作即時翻譯疊加

---

## 🐛 已知問題

### 高優先級
1. **對話摘要功能測試失敗**（3 個測試）
   - 錯誤：TypeError: Cannot read properties of undefined (reading '0')
   - 位置：server/routers.ts:444:36
   - 影響：對話摘要功能無法使用
   - 計劃：v1.1.1 修復

### 中優先級
2. **翻譯數量統計錯誤**（1 個測試）
   - 錯誤：預期 1，實際 4
   - 影響：歷史記錄顯示的翻譯數量不正確
   - 計劃：v1.1.1 修復

### 低優先級
3. **TTS Profiler 時間誤差**（1 個測試）
   - 錯誤：時間測量誤差 0.37ms
   - 影響：極小，可忽略
   - 計劃：v1.1.1 修復

4. **ASR 延遲過高**
   - 當前：2.5-3.5 秒
   - 目標：< 1.5 秒
   - 影響：翻譯延遲 > 3 秒
   - 計劃：v1.2.0 使用 Whisper Streaming API

---

## 📝 文件待辦

- [x] 測試報告（TEST_REPORT.md）
- [x] 版本歷史（VERSION_HISTORY.md）
- [x] 測試程序（TESTING_PROCEDURE.md）
- [x] 開發時程（DEVELOPMENT_SCHEDULE.md）
- [x] 待辦事項（todo.md）
- [ ] API 文件
- [ ] 使用者手冊
- [ ] 部署指南
- [ ] 故障排除指南

---

## 🧪 測試待辦

### 單元測試
- [x] 認證測試
- [x] 語音識別測試
- [x] 多語言翻譯測試
- [x] 語音合成測試
- [x] 對話管理測試
- [x] 歷史記錄測試
- [x] 效能測試
- [x] WebM 串流測試
- [ ] 對話摘要測試（待修復）

### 整合測試
- [x] 對話整合測試
- [x] OpenAI 整合測試
- [ ] 前端 E2E 測試（待建立）

### 手動測試
- [ ] 即時字幕清除功能（v1.1.0 修復驗證）
- [ ] VAD 語音活動檢測
- [ ] 多語言翻譯準確性
- [ ] UI 互動流程
- [ ] 錯誤處理

---

## 📊 效能優化待辦

### 當前效能指標
- ASR 延遲：2.5-3.5 秒
- 翻譯延遲：0.8-1.3 秒
- TTS 延遲：< 1 秒
- E2E 延遲：3.9 秒

### 目標效能指標（v1.2.0）
- ASR 延遲：1.0-1.5 秒（-50%）
- 翻譯延遲：0.5-0.8 秒（-30%）
- TTS 延遲：< 0.5 秒（-50%）
- E2E 延遲：2.0 秒（-48%）

### 優化項目
- [ ] 使用 Whisper Streaming API
- [ ] 優化翻譯模型
- [ ] 實作音訊預處理
- [ ] 實作快取機制
- [ ] 優化資料庫查詢
- [ ] 實作 CDN 加速

---

## 🔐 安全性待辦

- [ ] 實作 API rate limiting
- [ ] 實作 CSRF 保護
- [ ] 實作 XSS 防護
- [ ] 實作 SQL injection 防護
- [ ] 實作音訊檔案大小限制
- [ ] 實作使用者權限管理
- [ ] 實作敏感資料加密

---

## 📱 UI/UX 改善待辦

- [ ] 加入載入動畫
- [ ] 加入錯誤提示動畫
- [ ] 優化行動裝置體驗
- [ ] 加入鍵盤快捷鍵
- [ ] 加入深色模式
- [ ] 加入無障礙功能（ARIA）
- [ ] 加入多語言 UI（i18n）

---

## 🛠️ 技術債務

- [ ] 重構 Home.tsx（檔案過大，> 1000 行）
- [ ] 分離 VAD 邏輯到獨立模組
- [ ] 分離音訊處理邏輯到獨立模組
- [ ] 統一錯誤處理機制
- [ ] 加入 TypeScript strict mode
- [ ] 移除未使用的程式碼
- [ ] 優化 bundle size

---

## 📚 學習與研究

- [ ] 研究 Whisper Streaming API
- [ ] 研究 WebRTC 技術
- [ ] 研究語音情緒分析技術
- [ ] 研究說話者識別技術
- [ ] 研究離線翻譯技術
- [ ] 研究模型微調技術


---

## 🔥 緊急修復（2025-12-15 新增）

- [x] 修復 UI 對話框顯示邏輯錯誤
  - 問題：原文和譯文都顯示在同一側（speaker 判斷錯誤）
  - 修復：分離 sourceSpeaker 和 targetSpeaker
  - 修復：原文使用 sourceSpeaker，譯文使用 targetSpeaker
  - 結果：台灣人說中文 → 原文在左側，譯文在右側
  - 結果：外國人說外語 → 原文在右側，譯文在左側


## 🎨 UI 改善（2025-12-15 新增）

- [x] 加入「反向顯示」開關功能
  - 需求：透明螢幕雙面顯示，讓兩邊的人都能看到正向文字
  - 實作：新增 mirrorForeignView state 並儲存至 localStorage
  - 實作：在外國人對話框標題旁加入 toggle 按鈕
  - 實作：外國人字幕區域條件性加上 mirror-horizontal CSS class
  - 實作：確保只有字幕內容被翻轉，標題和按鈕不受影響
  - 結果：點擊「↔️ 翻轉」按鈕即可切換水平翻轉效果


## 🐛 Bug 修復（2025-12-16 新增）

- [x] 修復即時字幕「偵測中」泡泡重複顯示的 bug（v1.3.1）
  - 問題：畫面有兩個「即時字幕 偵測中」的泡泡
  - 原因：partial 訊息初始化邏輯有問題
  - 修復：確保 partial 訊息只在說話時創建


## 🎨 UI 改進 - iPhone 風格（2025-12-15 新增）

- [x] 合併原文和翻譯到同一個泡泡
  - 每個訊息泡泡同時顯示原文和翻譯
  - 中間用分隔線區隔
- [x] 改用對話泡泡樣式
  - rounded-2xl 圓角泡泡設計
  - shadow-lg 陰影效果
  - 更大的內距 (p-4 md:p-5)
- [x] 調整顏色方案
  - 原文：text-white 白色文字
  - 翻譯：text-cyan-400 青色文字
  - 字體加大 (text-lg md:text-xl)


## 🐛 Bug 修復（2025-12-16 新增）

- [x] 修改泡泡顯示邏輯（v1.3.4）
  - 問題：原文和翻譯顯示在不同側
  - 修復：讓原文和翻譯都顯示在說話者那一側的同一個泡泡裡
  - 改動：translatedMessage 的 speaker 改用 sourceSpeaker


## 🔧 測試修復（2025-12-16 新增）

- [x] 修復測試資料隔離問題
  - 問題：測試之間的資料互相影響，導致 messageCount 和 translationCount 錯誤
  - 修復：history.test.ts 使用唯一標題避免資料衝突
  - 修復：conversation.summary.test.ts 已使用唯一標題
  - 結果：所有 62 個測試通過（100% 通過率）

- [x] 修復 VAD 和 Whisper 幻覺問題
  - 問題：語音太長（>2.5s）被丟棄
  - 問題：Whisper 產生重複字串幻覺（如「謝謝,謝謝,謝謝...」）
  - 修復：移除語音太長限制，改用 auto-cut（4秒自動切段）
  - 修復：加入 detectWhisperHallucination 函數過濾重複字串
  - 結果：長句翻譯正常，幻覺被自動過濾


## 🐛 Bug 修復（2025-12-17 新增）

- [x] 修復中文翻譯成中文的問題
  - 問題：說中文時，翻譯結果也是中文，而不是目標語言（越南語）
  - 原因：Whisper 回傳 language: "unknown" 時，determineDirection 把它當成「非中文」
  - 修復：當 Whisper 回傳 "unknown" 時，預設為中文 "zh"
  - 同時優化翻譯 prompt 讓 Gemini 更好地遵循翻譯指令
